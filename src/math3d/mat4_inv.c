/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   mat4_inv.c                                         :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: bnesoi <bnesoi@student.42.fr>              +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2019/07/06 14:40:38 by bnesoi            #+#    #+#             */
/*   Updated: 2019/07/06 15:11:21 by bnesoi           ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "m3d.h"


static void		coefficient(t_mat4 *m, t_real *out)
{
	out[0] = M44(m, 1, 2) * M44(m, 2, 3) - M44(m, 1, 3) * M44(m, 2, 2);
	out[1] = M44(m, 1, 2) * M44(m, 3, 3) - M44(m, 1, 3) * M44(m, 3, 2);
	out[3] = M44(m, 2, 2) * M44(m, 3, 3) - M44(m, 2, 3) * M44(m, 3, 2);
	out[4] = M44(m, 2, 1) * M44(m, 3, 3) - M44(m, 2, 3) * M44(m, 3, 1);
	out[5] = M44(m, 1, 1) * M44(m, 3, 3) - M44(m, 1, 3) * M44(m, 3, 1);
	out[6] = M44(m, 1, 1) * M44(m, 2, 3) - M44(m, 1, 3) * M44(m, 2, 1);
	out[7] = M44(m, 2, 1) * M44(m, 3, 2) - M44(m, 2, 2) * M44(m, 3, 1);
	out[8] = M44(m, 1, 1) * M44(m, 3, 2) - M44(m, 1, 2) * M44(m, 3, 1);
	out[9] = M44(m, 1, 1) * M44(m, 2, 2) - M44(m, 1, 2) * M44(m, 2, 1);
	out[10] = M44(m, 2, 0) * M44(m, 3, 3) - M44(m, 2, 3) * M44(m, 3, 0);
	out[11] = M44(m, 2, 0) * M44(m, 3, 2) - M44(m, 2, 2) * M44(m, 3, 0);
	out[12] = M44(m, 2, 0) * M44(m, 3, 1) - M44(m, 2, 1) * M44(m, 3, 0);
	out[13] = M44(m, 1, 0) * M44(m, 3, 3) - M44(m, 1, 3) * M44(m, 3, 0);
	out[14] = M44(m, 1, 0) * M44(m, 3, 2) - M44(m, 1, 2) * M44(m, 3, 0);
	out[15] = M44(m, 1, 0) * M44(m, 2, 3) - M44(m, 1, 3) * M44(m, 2, 0);
	out[16] = M44(m, 1, 0) * M44(m, 2, 2) - M44(m, 1, 2) * M44(m, 2, 0);
	out[17] = M44(m, 1, 0) * M44(m, 3, 1) - M44(m, 1, 1) * M44(m, 3, 0);
	out[18] = M44(m, 1, 0) * M44(m, 2, 1) - M44(m, 1, 1) * M44(m, 2, 0);
}

static void		inv_apply_r34(const t_mat4 *m,
								 const t_real *c, t_mat4 *o, t_real d)
{
	M44(o, 2, 0) = d * (M44(m, 1, 0) * c[4] 
        - M44(m, 1, 1) * c[10] + M44(m, 1, 3) * c[12]);
	M44(o, 2, 1) = d * -(M44(m, 0, 0) * c[4] 
        - M44(m, 0, 1) * c[10] + M44(m, 0, 3) * c[12]);
	M44(o, 2, 2) = d * (M44(m, 0, 0) * c[5] 
        - M44(m, 0, 1) * c[13] + M44(m, 0, 3) * c[17]);
	M44(o, 2, 3) = d * -(M44(m, 0, 0) * c[6] 
        - M44(m, 0, 1) * c[15] + M44(m, 0, 3) * c[18]);
	M44(o, 3, 0) = d * -(M44(m, 1, 0) * c[7] 
        - M44(m, 1, 1) * c[11] + M44(m, 1, 2) * c[12]);
	M44(o, 3, 1) = d * (M44(m, 0, 0) * c[7] 
        - M44(m, 0, 1) * c[11] + M44(m, 0, 2) * c[12]);
	M44(o, 3, 2) = d * -(M44(m, 0, 0) * c[8] 
        - M44(m, 0, 1) * c[14] + M44(m, 0, 2) * c[17]);
	M44(o, 3, 3) = d * (M44(m, 0, 0) * c[9] 
        - M44(m, 0, 1) * c[16] + M44(m, 0, 2) * c[18]);
}

static void		inv_apply(const t_mat4 *m,
							 const t_real *c, t_mat4 *o, t_real d)
{
	M44(o, 0, 0) = d * (M44(m, 1, 1) * c[3] 
        - M44(m, 1, 2) * c[4] + M44(m, 1, 3) * c[7]);
	M44(o, 0, 1) = d * -(M44(m, 0, 1) * c[3] 
        - M44(m, 0, 2) * c[4] + M44(m, 0, 3) * c[7]);
	M44(o, 0, 2) = d * (M44(m, 0, 1) * c[1] 
        - M44(m, 0, 2) * c[5] + M44(m, 0, 3) * c[8]);
	M44(o, 0, 3) = d * -(M44(m, 0, 1) * c[0] 
        - M44(m, 0, 2) * c[6] + M44(m, 0, 3) * c[9]);
	M44(o, 1, 0) = d * -(M44(m, 1, 0) * c[3] 
        - M44(m, 1, 2) * c[10] + M44(m, 1, 3) * c[11]);
	M44(o, 1, 1) = d * (M44(m, 0, 0) * c[3] 
        - M44(m, 0, 2) * c[10] + M44(m, 0, 3) * c[11]);
	M44(o, 1, 2) = d * -(M44(m, 0, 0) * c[1] 
        - M44(m, 0, 2) * c[13] + M44(m, 0, 3) * c[14]);
	M44(o, 1, 3) = d * (M44(m, 0, 0) * c[0] 
        - M44(m, 0, 2) * c[15] + M44(m, 0, 3) * c[16]);
	inv_apply_r34(m, c, o, d);
}

t_mat4			*m4_inv(t_mat4 *m, t_mat4 *out)
{
	t_real d;
	t_real c[19];

	if (!m || !out)
		return (NULL);
	coefficient(m, c);
	d = M44(m, 0, 0) *
		(M44(m, 1, 1) * c[3] - M44(m, 1, 2) * c[4] + M44(m, 1, 3) * c[7])
		- M44(m, 0, 1) *
		  (M44(m, 1, 0) * c[3] - M44(m, 1, 2) * c[10] + M44(m, 1, 3) * c[11])
		+ M44(m, 0, 2) *
		  (M44(m, 1, 0) * c[4] - M44(m, 1, 1) * c[10] + M44(m, 1, 3) * c[12])
		- M44(m, 0, 3) *
		  (M44(m, 1, 0) * c[7] - M44(m, 1, 1) * c[11] + M44(m, 1, 2) * c[12]);
	if (d == 0)
		return (NULL);
	d = 1 / d;
	inv_apply(m, c, out, d);
	return (out);
}
